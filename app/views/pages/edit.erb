
<% form_for @page do |f| %>

  <table class="page-head">
    <tr>
      <td style="width:230px;">
        <%= f.label "Page Name" %> <span class="star_req">*</span>
        <%= f.text_field :name, {:rel => 'text_req', :style => 'width:130px' } %>
      </td>
      <td style="width:250px;">
        <%= f.label 'FB Page/Profile ID' %> <span class="star_req">*</span>
        <%= f.text_field :fb_sig_page_id, {:rel => 'text_req', :style => 'width:120px' } %>
      </td>
      <td style="width:120px;">
        <%= f.label :publish %>
        <%= f.check_box(:publish) %> (yes)
      </td>
      <td class="buttons" style="width:140px;">
        <%= link_to 'Facebook Preview', 'http://apps.facebook.com/aplanofattack/deploy/preview/' + @page.fb_sig_page_id, {:target => '_blank', :class => 'positive', :style => 'float:right; position:relative;'} %>
      </td>
      <td class="buttons" style="width:120px;">
        <button id="save-page" type="submit" class="positive" style="float:right">Save Changes</button>
      </td>
    </tr>
  </table>
  <%= f.text_area :body, :style => 'display:none' %>
  <%= f.text_area :css, :style => 'display:none' %>
<% end %>
      
  <ul id="page-tabs">
    <li title="View the latest rendered output of your page"><a href="deploy/preview/<%= @page.fb_sig_page_id %>" rel="tab-view" id="load">View Page</a></li>
    <li title="Edit the contents of your page"><a href="#body" rel="tab-body">Body</a></li>
    <li title="Edit the CSS of your main page"><a href="#css" rel="tab-css">CSS</a></li>
    <li title="Configure widgets to add to your page"><a href="#widget" rel="tab-widget">Widgets</a></li>
  </ul>

  <div id="main" rel="<%= @page.id %>">
    <div id="content">

      <div id="tab-view" class="tab-content">
        This is the view
      </div>
        
      <div id="tab-body" class="tab-content">
        <fieldset style="clear:both">
          <textarea id="page_body_helper"></textarea>
        </fieldset>
      </div>
     
      <div id="tab-css" class="tab-content">
        <fieldset style="clear:both">
          <textarea id="page_css_helper"></textarea>
        </fieldset>
      </div>

      <div id="tab-widget" class="tab-content">
        <div style="padding:3px;background:#ffff99;font-weight:bold; color:#000; text-align:center">
          Add a widget to your page by pasting the widget's code into your page body. (ex code: [#slider:1])
        </div>
        <div style="padding:5px;background:#ffffcc;margin-bottom:10px; overflow:hidden;">
          <h3 style="float:left; margin-right:10px;">My Slideshows</h3>
          <select class="widget-list" style="float:left; margin-right:10px;">
            <option value="0">Select a Slideshow</option>
          <% @page.sliders.each do |slider| %>
            <option value="<%=edit_slider_path(slider)%>">
              <%= slider.name %> => <b>[#slider:<%=slider.id%>]</b>
            </option>
          <% end %>
          </select>
          <%= link_to 'New Slideshow', new_page_slider_path(@page), :rel => 'facebox', :style => 'float:left' %>
        </div>
        <div id="widget-wrapper"></div>
      </div>
      
    </div>
  </div>

<script type="text/javascript">
$(function(){

  $('select.widget-list').change(function(){
    var url = $('option:selected', $(this)).val();
    if(url == 0) return;
    $('div#widget-wrapper').html(loading);
    $.get(url, function(view){
      $('div#widget-wrapper').html(view);
      $('ul#widget-tabs li a:first').click();
      $(document).trigger('ajaxify.forms');
    })    
    return false;
  });
  var editor = CodeMirror.fromTextArea('page_body_helper', {
    width: "820px",
    height: "700px",
    parserfile: ["parsexml.js", "parsecss.js", "tokenizejavascript.js", "parsejavascript.js", "parsehtmlmixed.js"],
    stylesheet: ["/stylesheets/codemirror/xmlcolors.css?232331sdf", "/stylesheets/codemirror/jscolors.css?12312"],
    path: "/javascripts/codemirror/",
    continuousScanning: 500,
    lineNumbers: true,
    textWrapping: false,
    saveFunction: function(){
      $('textarea#page_body').val(editor.getCode());
      $('form.edit_page').submit();
    }
  });

  var cssEditor = CodeMirror.fromTextArea('page_css_helper', {
    width: "820px",
    height: "700px",
    parserfile: "parsecss.js",
    stylesheet: "/stylesheets/codemirror/csscolors.css?3453",
    path: "/javascripts/codemirror/",
    continuousScanning: 500,
    lineNumbers: true,
    saveFunction: function(){
      $('textarea#page_css').val(cssEditor.getCode());
      $('form.edit_page').submit();
    }
  });

  editor.setCode($('textarea#page_body').val());
  cssEditor.setCode($('textarea#page_css').val());
  
 // overload save button for saving a page
  $('button#save-page').click(function(){
    $('textarea#page_body').val(editor.getCode());
    $('textarea#page_css').val(cssEditor.getCode());
  });
    
})
</script>

